<app-snomed-left-sidebar [categories]="categories" (categoryEmitter)="setCategory($event)" (searchTextEmitter)="setText($event)"></app-snomed-left-sidebar>

<div id="reporting" class="footer-margin">
    <div *ngFor="let category of categories | category:activeCategory?.name">
        <div class="p-4" *ngIf="(category.jobs | category:querySearch).length !== 0">
            <h2 class="report-title">{{category.name}}</h2>
            <div class="accordion rounded">
                <div class="query" *ngFor="let query of category.jobs | category:querySearch; let first = first; let last = last">
                    <div class="title" (click)="switchActiveQuery(query)" [class.rounded-top]="first" [class.rounded-bottom]="last" [class.last-item]="last">
                        <h3 class="float-left py-3 px-4 m-0">{{query.name}}</h3>
                    </div>
                    <div class="content" *ngIf="activeQuery === query">
                        <div class="row w-100 description mx-0">
                            <p class="float-left py-3 px-4 mb-0">{{query.description}}</p>
                            <button *ngIf="query === activeQuery" class="btn btn-primary m-2"
                                    (click)="(activeQuery.parameters.parameterMap) ? openQueryModal = true : submitReportRequest()">Run New Query
                            </button>
                        </div>
                        <div class="row flex-nowrap report-header run py-2 mx-0">
                            <div class="px-2 border-bar date">Date</div>
                            <div class="px-2 border-bar issues">Issues</div>
                            <div class="px-2 border-bar parameters" *ngFor="let parameter of query.parameters.parameterMap | keyvalue">{{parameter.key}}</div>
                            <div class="px-2 border-bar user">User</div>
                            <div class="px-2 status">Status</div>
                        </div>
                        <div *ngFor="let report of activeReportSet; let last = last" class="row flex-nowrap report run py-2 mx-0" [class.last-item]="last">
                            <div class="px-2 border-bar date">{{report.requestTime | date:'short'}}</div>
                            <div class="px-2 border-bar issues">{{report.issuesReported ? report.issuesReported : '0'}}</div>
                            <div class="px-2 border-bar parameters" *ngFor="let parameter of query.parameters.parameterMap | keyvalue">
                                {{report?.parameters.parameterMap[parameter.key].value}}
                            </div>
                            <div class="px-2 border-bar user">{{report.user}}</div>
                            <ng-container [ngSwitch]="report.status">
                                <div *ngSwitchCase="'Complete'" class="px-2 status completed" (click)="viewReport(report)">{{report.status}}
                                    <i class="fas fa-external-link-alt ml-1"></i>
                                </div>
                                <div *ngSwitchCase="'Failed'" class="px-2 status failed" matTooltip="{{report?.debugInfo}}">{{report.status}}
                                    <i class="fas fa-times-circle ml-1"></i>
                                </div>
                                <div *ngSwitchDefault class="px-2 status">{{report.status}}</div>
                            </ng-container>
                            <button class="delete-button" (click)="deleteReport(report)"><i class="fas fa-minus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<app-snomed-query-modal *ngIf="openQueryModal" [query]="activeQuery" (submitEmitter)="submitReportRequest()" (closeEmitter)="closeModal()"></app-snomed-query-modal>
<app-snomed-delete-modal *ngIf="openDeleteModal" [report]="activeReport" (closeEmitter)="closeModal()"></app-snomed-delete-modal>
