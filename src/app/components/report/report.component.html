<div id="report" class="footer-margin">
    <div *ngIf="activeReport" class="p-5">
        <div class="float-end m-2">
            <button class="btn p-2 px-3 mx-3 whitelist" data-toggle="modal" data-target="#whitelistModal"
                    (click)="openModal('whitelist-modal'); searchTerm = ''; getWhitelist()">
                Whitelist
            </button>
            <button class="btn p-2 px-3 new-run" data-toggle="modal" data-target="#queryModal" (click)="openModal('query-modal')">
                Run New Query
            </button>
        </div>
        <h2 class="mb-3">{{activeReport.name}}</h2>
        <p class="description mb-3 text-bootstrap-black">{{activeReport.description}}</p>

    </div>
    <div *ngIf="runs && runs[0]">
        <table class="table table-bordered">
            <thead>
            <tr class="table-title">
                <th class="p-3">Issues</th>
                <th class="p-3">Project</th>
                <th class="p-3" *ngFor="let parameter of runs[0].parameters | keyvalue | displayOrder | hidden">{{parameter.key}}</th>
                <th class="p-3">Info</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let run of runs | slice:0:20" class="table-body position-relative">
                <td class="p-3">{{run.issuesReported ? run.issuesReported : '0'}}</td>
                <td class="p-3">{{run.project}}</td>
                <td class="p-3 parameter" *ngFor="let parameter of runs[0].parameters | keyvalue | displayOrder | hidden">{{run?.parameters ? run.parameters[parameter.key]?.value : ''}}</td>
                <td class="p-3 info">
                    <span class="user mb-2">{{run.user}} </span>
                    <span class="time mb-2">{{convertDate(run.requestTime)}} UTC </span>
                    <ng-container [ngSwitch]="run.status">
                        <span *ngSwitchCase="'Complete'" class="status completed" (click)="viewReport(run)">{{run.status}}<i class="fas fa-external-link-alt ms-1"></i></span>
                        <ng-container *ngSwitchCase="'Failed'">
                            <span *ngIf="run.resultUrl" class="status failed" (click)="viewReport(run)" ngbTooltip="{{run?.debugInfo}}">{{run.status}}<i class="fas fa-external-link-alt ms-1"></i></span>
                            <span *ngIf="!run.resultUrl" class="status failed" ngbTooltip="{{run?.debugInfo}}">{{run.status}}<i class="fas fa-times-circle ms-1"></i></span>
                        </ng-container>
                        <span *ngSwitchDefault class="status running">{{run.status}}</span>
                    </ng-container>
                </td>
                <button class="delete-button btn rounded text-center p-0" (click)="openModal('delete-modal'); activeReport = run" data-toggle="modal" data-target="#deleteModal"><i class="fas fa-times"></i></button>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- DELETE MODAL -->
<app-modal id="delete-modal" class="modal">
    <div header><h3 class="mb-0">Delete<span class="px-2">{{activeReport?.name}}</span></h3></div>
    <div body>Are you sure you want to delete this report?</div>
    <div footer>
        <button type="button" class="btn btn-primary" (click)="deleteReport(); closeModal('delete-modal')">Delete Report</button>
    </div>
</app-modal>

<!-- QUERY MODAL -->
<app-modal id="query-modal" class="modal">
    <div header><h3 class="mb-0">Details<span class="px-2">{{activeReport?.name}}</span></h3></div>
    <div body>
        <app-query-parameters [query]="activeReport"></app-query-parameters>
    </div>
    <div footer>
        <div [@slide]="saved" class="px-3 error">{{saveResponse}}</div>
        <button type="button" class="btn btn-primary" (click)="missingFieldsCheck()">Run Query</button>
    </div>
</app-modal>

<!-- WHITELIST MODAL -->
<app-modal id="whitelist-modal" class="modal" size="xl">
    <h3 header class="mb-0">Whitelist<span class="px-2">{{activeReport?.name}}</span></h3>
    <div body>
        <div class="position-relative pb-3">
            <label class="w-100 m-0">Add concept to whitelist</label>
            <input type="text" class="form-control" [(ngModel)]="searchTerm" [ngbTypeahead]="search" (ngModelChange)="retrieveConceptsById(searchTerm)"/>
            <div class="note font-italic">Multiple hierarchies can be entered via comma separation</div>
        </div>
        <div *ngIf="whitelist?.length > 0; else noItems" class="table-container border">
            <table class="table table-borderless rounded m-0">
                <tr>
                    <th class="p-2">ID</th>
                    <th class="p-2">Name</th>
                </tr>
                <tr *ngFor="let concept of whitelist" [class.new]="concept.new" class="position-relative">
                    <td class="p-2">{{concept.sctId}}</td>
                    <td class="p-2">{{concept.fsn}}</td>
<!--                    <button class="delete-button" (click)="removeFromWhitelist(concept)"><i class="fas fa-minus"></i></button>-->
                    <button class="delete-button btn rounded text-center p-0" (click)="removeFromWhitelist(concept)"><i class="fas fa-times"></i></button>
                </tr>
            </table>
        </div>
        <ng-template #noItems>
            <div class="note text-center">- No items whitelisted -</div>
        </ng-template>
    </div>
    <div footer>
        <div [@slide]="saved" class="px-3 saved">{{saveResponse}}</div>
        <button type="button" class="btn btn-primary" [disabled]="!whitelistChanged" (click)="saveWhitelist()">Save Whitelist</button>
    </div>
</app-modal>
